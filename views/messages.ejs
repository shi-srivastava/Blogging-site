<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
  <!-- <link rel="stylesheet" href="css/messages.css"> -->
  <!-- <script src="https://cdn.socket.io/3.1.3/socket.io.min.js" integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh" crossorigin="anonymous"></script> -->
<script src="https://cdn.socket.io/4.0.1/socket.io.js"></script>
<style>
  a{
background-color: cornsilk;
color: black;
width: 100px;
    }
</style>
</head>
<body>
  

 <input type="text" name="r" id="r" placeholder="Enter receiver's name" onkeyup="search()">
 <div id="search"></div>
 <button onclick="create_new_chat()">+new chat</button>
 <br><br>
 <div id="users" style="width: 40%; margin-left: 0;">
</div>
<label for="counter"></label>
<div  class="send_div" style="width:60%; right: 0px; position: absolute;" >
<strong><label for="receiver"  style="bottom: 0px;">receiver</label></strong>
<div id="chat"></div>
<input type="text" name="input msg" style="margin-bottom: 0;">
<button class="send" onclick="on_post(this)" style="margin-bottom:0 ;">
  Send</button>
</div>
  <script>
    let sender = "<%= username %>"
const search =()=>{
       let search_div = document.getElementById("search")
       let search_item = $("input[name='r']").val()
      // alert(search_select)
       $.ajax({
         url:"/search",
         method:"POST",
         data:{data:search_item},
         success:function(response){
          if(response!=null){
            
            response.forEach(res=>{
              let anchor = document.getElementsByClassName('user-suggestion')
              let flag =0
              for(let i=0;i<anchor.length;i++){
                if(anchor[i].innerText == res.username){
                  flag=1
                }
              }
              if(flag!=1){
             let btn = document.createElement('button')
             btn.classList.add("user-suggestion")
             btn.innerHTML = res.username
             btn.onclick =function(){
               document.getElementById("r").value = btn.innerHTML
             }
             $("#search").append(btn)
             let linebreak = document.createElement('br')
             $("#search").append(linebreak)


              }
               
           })
          
          }
          
          if( search_item.length ==0){
            search_div.innerHTML =''
          }
         }
       })
     }

        const socket = io.connect("http://localhost:3000")
        // const socket = io()
      let chat_div = document.getElementById("chat")
      socket.on("express-chat",data=>{
        
       chat_div.innerHTML += '<p>'+data.msg +'</p>'
      })
        
      const show_notif=()=>{
        
       $.ajax({
         url: "/get-unread",
         method:"POST",
         data:{sender:sender},
         success:function(rooms){
         rooms.forEach(room=>{
           
           let btn = document.getElementById(room)
           if(btn){
             if(!btn.innerHTML.includes(" *")){
               btn.innerHTML += " *"
             }
           }
         })
          
         }
       })
      }
      setInterval(show_notif,3000)
//GET SENDERS
      const get_senders =()=>{
      document.getElementById("users").innerHTML =""

    
        $.ajax({
          url:"/get-my-senders",
          method:"POST",
          data:{sender:sender},
          success:function(res){
            res.forEach(res=>{
            if(res.roomID!=undefined){
          let btn = document.createElement('button')
            btn.id = res.roomID
            if(res.sender == sender){
             
              btn.innerHTML =""+res.receiver
            }
            if(res.receiver == sender){
              
              btn.innerHTML =""+res.sender

            }


            btn.onclick = function(){
        let cur_room = document.getElementsByClassName("active_room")
        if(cur_room.length>0){
        alert(cur_room[0].id)
      socket.emit("join-room",{room:btn.id, prev_room: cur_room[0].id})
        cur_room[0].classList.remove("active_room")

        }
       else{
      socket.emit("join-room",{room:btn.id, prev_room: "nothing"})

       }
        document.getElementById(btn.id).classList.add("active_room")

        let send_btn = document.getElementsByClassName("send")
        send_btn[0].id = btn.id
      chat_div.innerHTML =""
      if(btn.innerHTML.includes(" *")){
       let a = btn.innerHTML
       a = a.replace(" *","")
       btn.innerHTML = a
      }
      let val = ""+btn.innerHTML

      $("label[for='receiver']").html(val)

       //AJAX
       $.ajax({
        url:"/get-chats",
        method:"POST",
        data:{roomID:btn.id},
        success:function(data){
         (data).forEach(msg=>{
          for(let i=0;i<msg.chats.length;i++){
            if(msg.chats[i].data != undefined){
             if(msg.chats[i].username == sender){
            chat_div.innerHTML += '<p style="margin-left:100px;">'+msg.chats[i].data+'</p>'
           }
           if(msg.chats[i].username != sender){
            chat_div.innerHTML += '<p >'+msg.chats[i].data+'</p>'

           }
          }
          }
          
           
         })
        }
      })
       //
        
      }

      document.getElementById("users").prepend(btn)
      let linebreak = document.createElement("br")
      document.getElementById("users").prepend(linebreak)
          }
        }
            )}
        })
      }

      window.onload = get_senders()
    const create_new_chat =()=>{
    

      let receiver = $("input[name='r']").val()
      // alert(receiver)
      alert(sender)
      $.ajax({
        url:"/get-room-id",
        method:"POST",
        data:{sender:sender,r:receiver},
        success:function(id){
         window.location.href = window.location
        }

      })
     
    }

    const on_post =(btn)=>{
      
      let receiver = $("input[name='r']").val()
      let msg = $("input[name='input msg']").val()
     let isRead = 0
      socket.emit("get-clients-no",btn.id)
      socket.on("get-clients-no",data=>{
        if(data==1){
        $.ajax({
        url:"/send-msg",
        method:"POST",
        data:{msg:msg,sender:sender,roomID:btn.id, receiver:receiver,isRead:1},
        success:function(){
          alert("done "+isRead)
        }
      })
        }
        else{
          $.ajax({
        url:"/send-msg",
        method:"POST",
        data:{msg:msg,sender:sender,roomID:btn.id, receiver:receiver,isRead:0},
        success:function(){
          alert("done "+isRead)
          
        }
      })
        }
      })
      
      
      // $.ajax({
      //   url:"/send-msg",
      //   method:"POST",
      //   data:{msg:msg,sender:sender,roomID:btn.id, receiver:receiver,isRead:isRead},
      //   success:function(){
          
      //   }
      // })
      
      socket.emit("express-chat",{roomID:btn.id,msg:msg})
      
      chat_div.innerHTML += '<p style="margin-left:100px;">' +msg+'</p>'
    }
    const show_chat =()=>{
      let send_btn = document.getElementsByClassName("send")

      let btn = send_btn[0]
      
      let i=0
      $.ajax({
        url:"/get-chats",
        method:"POST",
        data:{roomID:btn.id},
        success:function(data){
         (data).forEach(msg=>{
          for(let i=0;i<msg.chats.length;i++){
            if(msg.chats[i].data != undefined){
             if(msg.chats[i].username == sender){
            chat_div.innerHTML += '<p style="margin-left:100px;">'+msg.chats[i].data+'</p>'
           }
           if(msg.chats[i].username != sender){
            chat_div.innerHTML += '<p >'+msg.chats[i].data+'</p>'

           }
          }
          }
          
           
         })
        }
      })
      
    }
  </script>
</body>
</html>